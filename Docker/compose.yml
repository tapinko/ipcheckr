services:
  ipcheckr:
    image: ${DOCKER_IMAGE}
    container_name: ${CONTAINER_IPCHECKR}
    depends_on:
      - db
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - TZ=${TZ}
      - LDAP_HOST=${LDAP_HOST}
      - LDAP_PORT=${LDAP_PORT}
      - LDAP_STARTTLS=${LDAP_STARTTLS}
      - LDAP_FETCH_CERT=${LDAP_FETCH_CERT}
      - Gns3__LauncherPort=${GNS3_LAUNCHER_PORT}
      - Gns3__LauncherCaPath=/etc/ipcheckr/gns3/ca.crt
      - Gns3__UseTls=${GNS3_USE_TLS}
      - Gns3__LauncherHost=${GNS3_LAUNCHER_HOST}
      - Gns3__LauncherTimeoutSeconds=${GNS3_LAUNCHER_TIMEOUT}
      - Gns3__LauncherRetries=${GNS3_LAUNCHER_RETRIES}
    ports:
      - "${WEB_PORT}:8081"
    volumes:
      - /etc/ipcheckr/gns3/ca.crt:/etc/ipcheckr/gns3/ca.crt:ro
    dns:
      - ${DNS_NAMESERVER}
    dns_search:
      - ${DNS_SEARCH_DOMAIN}
    extra_hosts:
      - "ldap.example.local:${DNS_NAMESERVER}"
      - "server.ldap.example.local:${DNS_NAMESERVER}"
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  db:
    image: ${MARIADB_IMAGE}
    container_name: ${CONTAINER_DATABASE}
    networks:
      default:
        aliases:
          - ${DB_HOST}
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - ipcheckr_data:/var/lib/mysql
    restart: unless-stopped

volumes:
  ipcheckr_data: